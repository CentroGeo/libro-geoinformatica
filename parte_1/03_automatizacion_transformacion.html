<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Geoinformática - 3&nbsp; Automatización</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../parte_1/04_visualizacion_covid_1.html" rel="next">
<link href="../parte_1/02_ejemplo_transformacion.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Automatización</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Geoinformática</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Prefacio</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">Introducción</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../parte_1.html" class="sidebar-item-text sidebar-link">Geoinformática: las herramientas básicas</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/01_transformacion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Transformación de datos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/02_ejemplo_transformacion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Limpieza y transformación de datos de COVID-19 en México</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/03_automatizacion_transformacion.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Automatización</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/04_visualizacion_covid_1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Curvas epidémicas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/05_intro_geopandas.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Objetos geográficos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/06_manipulacion_espacial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Trabajando con objetos espaciales</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/07_mapas_COVID.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Mapas COVID</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/08_pesos_espaciales.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Pesos Espaciales</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/09_autocorrelacion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Autocorrelación espacial</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../parte_2.html" class="sidebar-item-text sidebar-link">Geoinformática en R</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_2/intro_R.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Introducción a R</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../summary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Summary</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#bajar-y-guardar-datos" id="toc-bajar-y-guardar-datos" class="nav-link active" data-scroll-target="#bajar-y-guardar-datos"><span class="toc-section-number">3.1</span>  Bajar y guardar datos</a></li>
  <li><a href="#preproceso" id="toc-preproceso" class="nav-link" data-scroll-target="#preproceso"><span class="toc-section-number">3.2</span>  Preproceso</a></li>
  <li><a href="#preprocesar-usando-nuestras-funciones" id="toc-preprocesar-usando-nuestras-funciones" class="nav-link" data-scroll-target="#preprocesar-usando-nuestras-funciones"><span class="toc-section-number">3.3</span>  Preprocesar usando nuestras funciones</a></li>
  <li><a href="#guardando-el-resultado" id="toc-guardando-el-resultado" class="nav-link" data-scroll-target="#guardando-el-resultado"><span class="toc-section-number">3.4</span>  Guardando el resultado</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Automatización</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>En el taller anterior vimos toda una serie de pasos para preprocesar los datos de COVUD-19. En esta actividad lo único que vamos a hacer es definir un par de funciones que realizan todo el flujo de preproceso. De esta forma podemos repetir todo el procedimiento de forma fácil.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os <span class="co"># hablar con el sistema operativo</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob <span class="co"># listar directorios y ese tipo de operaciones</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools <span class="co"># herramientas para iterar objetos</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path <span class="co"># manipular rutas a directorios</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile <span class="co"># comprimir y descomprimir archivos</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np <span class="co"># operaciones vectorizadas</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd <span class="co"># DataFrames</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> timedelta, date, datetime <span class="co"># Manejar fechas</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openpyxl <span class="co"># leer/escribir archivos de exel</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests <span class="co"># Hablar con direcciones web</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="bajar-y-guardar-datos" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="bajar-y-guardar-datos"><span class="header-section-number">3.1</span> Bajar y guardar datos</h2>
<p>En el taller anterior bajamos los datos directamente del sitio de la Secretaría de Salud, ahora vamos a automatizar el proceso de descarga de datos de forma que, desde Python, podamos descargar los datos y asegurarnos de que tenemos la última versión disponible.</p>
<p>Descargar y guardar archivos en Python es relativamente sencillo, vamos a usar tres módulos de la distribución base de Python:</p>
<ul>
<li><a href="https://docs.python.org/3/library/os.html">os</a>. Este módulo provee herramientas para interactuar con el sistema operativo. La vamos a usar para construir los <em>paths</em> en donde vamos a guardar los datos y preguntar si el archivo ya existe.</li>
<li><a href="https://requests.readthedocs.io/en/latest/">requests</a>. Esta librería provee diferentes formas de interactuar con el protocolo HTTP. La vamos a usar para hacer las <em>peticiones</em> a la página y procesar la respuesta.</li>
<li><a href="https://docs.python.org/3/library/zipfile.html">zipfile</a>. Esta librería sirve para trabajar con archivos comprimidos en formato <em>zip</em>. En nuestro caso la usaremos para descomprimir los diccionarios.</li>
</ul>
<p>La parte complicada de entender es el uso de <code>requests</code> pra comunicarse con la página en donde están los datos.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(<span class="st">"https://www.centrogeo.org.mx/"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>r.content[<span class="dv">0</span>:<span class="dv">500</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>b'\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n&lt;!DOCTYPE html&gt;\r\n&lt;html lang="es-es" dir="ltr" class=\'com_content view-featured itemid-101 home j31 mm-hover\'&gt;\r\n&lt;head&gt;\r\n&lt;base href="https://www.centrogeo.org.mx/" /&gt;\n\t&lt;meta http-equiv="content-type" content="text/html; charset=utf-8" /&gt;\n\t&lt;meta name="keywords" content="M\xc3\xa9xico, CONACYT, CentroGeo, Ciencias de Informaci\xc3\xb3n Geoespacial, Centro de Investigaci\xc3\xb3n, Ciencias de Informaci\xc3\xb3n, Investigaci\xc3\xb3n, Geoespacial" /&gt;\n\t&lt;meta name="rights" content="Esta obra est\xc3\xa1 bajo una licencia d'</code></pre>
</div>
</div>
<p>Como ven, una <em>petición</em> de tipo <em>get</em> simplemente nos regresa, a través de la propiedad <em>content</em>, el contenido de la respuesta del servidor. En el caso de la página de CentroGeo, el contenido es el HTML de la página (que podríamos ver mejor con un browser), pero en el caso de que la dirección apunte a un archivo de descarga, el contenido es el <em>stream</em> de datos del archivo. Este <em>stream</em> de datos lo podemos usar como entrada para escribir un archivo utilizando la función <a href="https://www.w3schools.com/python/ref_func_open.asp">open</a>.</p>
<p>La función <code>open</code> va a tomar como entrada el <em>path</em> en donde queremos guardar el archivo, este <em>path</em> puede ser simplemente una cadena de caracteres, sin embargo esto haría que nuestro código no fuera interoperable entre sistemas operativos, entonces, en lugar de escribir el <em>path</em> como cadena de caracteres, vamos a escribirlo como un <em>objeto</em> de <code>os</code>:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>os.path.join(<span class="st">"datos"</span>, <span class="st">"datos_covid.zip"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>'datos/datos_covid.zip'</code></pre>
</div>
</div>
<p>Esta forma de construir el <em>path</em> nos asegura que va a funcionar en cualquier sistema operativo.</p>
<p>Ya con estas explicaciones, podemos escribir la función que descarga los datos:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bajar_datos_salud(directorio_datos<span class="op">=</span><span class="st">'data/'</span>):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">        Descarga el ultimo archivo disponible en datos abiertos y los diccionarios correspondientes.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    fecha_descarga <span class="op">=</span> datetime.now().date()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    url_datos <span class="op">=</span> <span class="st">'https://datosabiertos.salud.gob.mx/gobmx/salud/datos_abiertos/datos_abiertos_covid19.zip'</span>    </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    archivo_nombre <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>fecha_descarga<span class="sc">.</span>strftime(<span class="st">"%y%m</span><span class="sc">%d</span><span class="st">"</span>)<span class="sc">}</span><span class="ss">COVID19MEXICO.csv.zip'</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    archivo_ruta <span class="op">=</span> os.path.join(directorio_datos, archivo_nombre)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    url_diccionario <span class="op">=</span> <span class="st">'https://datosabiertos.salud.gob.mx/gobmx/salud/datos_abiertos/diccionario_datos_covid19.zip'</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    diccionario_ruta <span class="op">=</span> os.path.join(directorio_datos, <span class="st">'diccionario.zip'</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(archivo_ruta):</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        logging.debug(<span class="ss">f'Ya existe </span><span class="sc">{</span>archivo_nombre<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Bajando datos...'</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> requests.get(url_datos, allow_redirects<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">open</span>(archivo_ruta, <span class="st">'wb'</span>).write(r.content)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> requests.get(url_diccionario, allow_redirects<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">open</span>(diccionario_ruta, <span class="st">'wb'</span>).write(r.content)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> zipfile.ZipFile(diccionario_ruta, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>          zip_ref.extractall(directorio_datos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para utilizar la función hacemos:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>bajar_datos_salud(<span class="st">'datos/'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bajando datos...</code></pre>
</div>
</div>
</section>
<section id="preproceso" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="preproceso"><span class="header-section-number">3.2</span> Preproceso</h2>
<p>Ahora, ya que tenemos los datos descargados, vamos a <em>empaquetar</em> en una función el flujo de preproceso que trabajamos en el taller anterior. Esta función va a tomar como entrada la carpeta en donde se encuentran los datos y dicionariosy el nombre del archivo de datos que queremos procesar. Toma dos parámetros adicionales, uno para decidir si queremos resolver o no las claves binarias y otro para definir la entidad que queremos procesar.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> carga_datos_covid19_MX(data_dir<span class="op">=</span><span class="st">'datos/'</span>, archivo<span class="op">=</span><span class="st">'datos_abiertos_covid19.zip'</span>, resolver_claves<span class="op">=</span><span class="st">'si_no_binarias'</span>, entidad<span class="op">=</span><span class="st">'09'</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">        Lee en un DataFrame el CSV con el reporte de casos de la Secretaría de Salud de México publicado en una fecha dada. Esta función</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">        también lee el diccionario de datos que acompaña a estas publicaciones para preparar algunos campos, en particular permite la funcionalidad</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">        de generar columnas binarias para datos con valores 'SI', 'No'.</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">        **Nota 2**: Por las actualizaciones a los formatos de datos, esta función sólo va a servir para archivos posteriores a 20-11-28</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">        resolver_claves: 'sustitucion', 'agregar', 'si_no_binarias', 'solo_localidades'. Resuelve los valores del conjunto de datos usando el</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">        diccionario de datos y los catálogos. 'sustitucion' remplaza los valores en las columnas, 'agregar'</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">        crea nuevas columnas. 'si_no_binarias' cambia valores SI, NO, No Aplica, SE IGNORA, NO ESPECIFICADO por 1, 0, 0, 0, 0 respectivamente.</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    catalogo_nombre <span class="op">=</span><span class="st">'201128 Catalogos.xlsx'</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    catalogo_path <span class="op">=</span> os.path.join(data_dir, catalogo_nombre)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    descriptores_nombre <span class="op">=</span> <span class="st">'201128 Descriptores.xlsx'</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    descriptores_path <span class="op">=</span> os.path.join(data_dir, descriptores_nombre)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    data_file <span class="op">=</span> os.path.join(data_dir, archivo)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(data_file)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(data_file, dtype<span class="op">=</span><span class="bu">object</span>, encoding<span class="op">=</span><span class="st">'latin-1'</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> entidad <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>      df <span class="op">=</span> df[df[<span class="st">'ENTIDAD_RES'</span>] <span class="op">==</span> entidad]</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hay un error y el campo OTRA_COMP es OTRAS_COMP según los descriptores</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    df.rename(columns<span class="op">=</span>{<span class="st">'OTRA_COM'</span>: <span class="st">'OTRAS_COM'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Asignar clave única a municipios</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'MUNICIPIO_RES'</span>] <span class="op">=</span> df[<span class="st">'ENTIDAD_RES'</span>] <span class="op">+</span> df[<span class="st">'MUNICIPIO_RES'</span>]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'CLAVE_MUNICIPIO_RES'</span>] <span class="op">=</span> df[<span class="st">'MUNICIPIO_RES'</span>]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Leer catalogos</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    nombres_catalogos <span class="op">=</span> [<span class="st">'Catálogo de ENTIDADES'</span>,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Catálogo MUNICIPIOS'</span>,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Catálogo RESULTADO'</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Catálogo SI_NO'</span>,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Catálogo TIPO_PACIENTE'</span>]</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    nombres_catalogos.append(<span class="st">'Catálogo CLASIFICACION_FINAL'</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    nombres_catalogos[<span class="dv">2</span>] <span class="op">=</span> <span class="st">'Catálogo RESULTADO_LAB'</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    dict_catalogos <span class="op">=</span> pd.read_excel(catalogo_path,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                              nombres_catalogos,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>                              dtype<span class="op">=</span><span class="bu">str</span>,</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>                              engine<span class="op">=</span><span class="st">'openpyxl'</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    entidades <span class="op">=</span> dict_catalogos[nombres_catalogos[<span class="dv">0</span>]]</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    municipios <span class="op">=</span> dict_catalogos[nombres_catalogos[<span class="dv">1</span>]]</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    tipo_resultado <span class="op">=</span> dict_catalogos[nombres_catalogos[<span class="dv">2</span>]]</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    cat_si_no <span class="op">=</span> dict_catalogos[nombres_catalogos[<span class="dv">3</span>]]</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    cat_tipo_pac <span class="op">=</span> dict_catalogos[nombres_catalogos[<span class="dv">4</span>]]</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Arreglar los catálogos que tienen mal las primeras líneas</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    dict_catalogos[nombres_catalogos[<span class="dv">2</span>]].columns <span class="op">=</span> [<span class="st">"CLAVE"</span>, <span class="st">"DESCRIPCIÓN"</span>]</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    dict_catalogos[nombres_catalogos[<span class="dv">5</span>]].columns <span class="op">=</span> [<span class="st">"CLAVE"</span>, <span class="st">"CLASIFICACIÓN"</span>, <span class="st">"DESCRIPCIÓN"</span>]</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    clasificacion_final <span class="op">=</span> dict_catalogos[nombres_catalogos[<span class="dv">5</span>]]</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resolver códigos de entidad federal</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    cols_entidad <span class="op">=</span> [<span class="st">'ENTIDAD_RES'</span>, <span class="st">'ENTIDAD_UM'</span>, <span class="st">'ENTIDAD_NAC'</span>]</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'CLAVE_ENTIDAD_RES'</span>] <span class="op">=</span> df[<span class="st">'ENTIDAD_RES'</span>]</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    df[cols_entidad] <span class="op">=</span> df[cols_entidad].replace(to_replace<span class="op">=</span>entidades[<span class="st">'CLAVE_ENTIDAD'</span>].values,</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>                                               value<span class="op">=</span>entidades[<span class="st">'ENTIDAD_FEDERATIVA'</span>].values)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construye clave unica de municipios de catálogo para resolver nombres de municipio</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    municipios[<span class="st">'CLAVE_MUNICIPIO'</span>] <span class="op">=</span> municipios[<span class="st">'CLAVE_ENTIDAD'</span>] <span class="op">+</span> municipios[<span class="st">'CLAVE_MUNICIPIO'</span>]</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resolver códigos de municipio</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    municipios_dict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(municipios[<span class="st">'CLAVE_MUNICIPIO'</span>], municipios[<span class="st">'MUNICIPIO'</span>]))</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'MUNICIPIO_RES'</span>] <span class="op">=</span> df[<span class="st">'MUNICIPIO_RES'</span>].<span class="bu">map</span>(municipios_dict.get)</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resolver resultados</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    df.rename(columns<span class="op">=</span>{<span class="st">'RESULTADO_LAB'</span>: <span class="st">'RESULTADO'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    tipo_resultado[<span class="st">'DESCRIPCIÓN'</span>].replace({<span class="st">'POSITIVO A SARS-COV-2'</span>: <span class="st">'Positivo SARS-CoV-2'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>    tipo_resultado <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(tipo_resultado[<span class="st">'CLAVE'</span>], tipo_resultado[<span class="st">'DESCRIPCIÓN'</span>]))</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'RESULTADO'</span>] <span class="op">=</span> df[<span class="st">'RESULTADO'</span>].<span class="bu">map</span>(tipo_resultado.get)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    clasificacion_final <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(clasificacion_final[<span class="st">'CLAVE'</span>], clasificacion_final[<span class="st">'CLASIFICACIÓN'</span>]))</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'CLASIFICACION_FINAL'</span>] <span class="op">=</span> df[<span class="st">'CLASIFICACION_FINAL'</span>].<span class="bu">map</span>(clasificacion_final.get)</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resolver datos SI - NO</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Necesitamos encontrar todos los campos que tienen este tipo de dato y eso</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># viene en los descriptores, en el campo FORMATO_O_FUENTE</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    descriptores <span class="op">=</span> pd.read_excel(<span class="ss">f'</span><span class="sc">{</span>data_dir<span class="sc">}</span><span class="ss">201128 Descriptores_.xlsx'</span>,</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>                                 index_col<span class="op">=</span><span class="st">'Nº'</span>,</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>                                 engine<span class="op">=</span><span class="st">'openpyxl'</span>)</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    descriptores.columns <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> col: col.replace(<span class="st">' '</span>, <span class="st">'_'</span>), descriptores.columns))</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    descriptores[<span class="st">'FORMATO_O_FUENTE'</span>] <span class="op">=</span> descriptores.FORMATO_O_FUENTE.<span class="bu">str</span>.strip()</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>    datos_si_no <span class="op">=</span> descriptores.query(<span class="st">'FORMATO_O_FUENTE == "CATÁLOGO: SI_ NO"'</span>)</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    cat_si_no[<span class="st">'DESCRIPCIÓN'</span>] <span class="op">=</span> cat_si_no[<span class="st">'DESCRIPCIÓN'</span>].<span class="bu">str</span>.strip()</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>    campos_si_no <span class="op">=</span> datos_si_no.NOMBRE_DE_VARIABLE</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    nuevos_campos_si_no <span class="op">=</span> campos_si_no</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> resolver_claves <span class="op">==</span> <span class="st">'agregar'</span>:</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>        nuevos_campos_si_no <span class="op">=</span> [nombre_var <span class="op">+</span> <span class="st">'_NOM'</span> <span class="cf">for</span> nombre_var <span class="kw">in</span> campos_si_no]</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> resolver_claves <span class="op">==</span> <span class="st">'si_no_binarias'</span>:</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>        nuevos_campos_si_no <span class="op">=</span> [nombre_var <span class="op">+</span> <span class="st">'_BIN'</span> <span class="cf">for</span> nombre_var <span class="kw">in</span> campos_si_no]</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>        cat_si_no[<span class="st">'DESCRIPCIÓN'</span>] <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> val: <span class="dv">1</span> <span class="cf">if</span> val <span class="op">==</span> <span class="st">'SI'</span> <span class="cf">else</span> <span class="dv">0</span>, cat_si_no[<span class="st">'DESCRIPCIÓN'</span>]))</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>    df[nuevos_campos_si_no] <span class="op">=</span> df[datos_si_no.NOMBRE_DE_VARIABLE].replace(</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>                                                to_replace<span class="op">=</span>cat_si_no[<span class="st">'CLAVE'</span>].values,</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>                                                value<span class="op">=</span>cat_si_no[<span class="st">'DESCRIPCIÓN'</span>].values)</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resolver tipos de paciente</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>    cat_tipo_pac <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(cat_tipo_pac[<span class="st">'CLAVE'</span>], cat_tipo_pac[<span class="st">'DESCRIPCIÓN'</span>]))</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'TIPO_PACIENTE'</span>] <span class="op">=</span> df[<span class="st">'TIPO_PACIENTE'</span>].<span class="bu">map</span>(cat_tipo_pac.get)</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> procesa_fechas(df)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> procesa_fechas(covid_df):</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> covid_df.copy()</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'FECHA_INGRESO'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'FECHA_INGRESO'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'FECHA_SINTOMAS'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'FECHA_SINTOMAS'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>)</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'FECHA_DEF'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'FECHA_DEF'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">"</span>, errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'DEFUNCION'</span>] <span class="op">=</span> (df[<span class="st">'FECHA_DEF'</span>].notna()).astype(<span class="bu">int</span>)</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'EDAD'</span>] <span class="op">=</span> df[<span class="st">'EDAD'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preprocesar-usando-nuestras-funciones" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="preprocesar-usando-nuestras-funciones"><span class="header-section-number">3.3</span> Preprocesar usando nuestras funciones</h2>
<div class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> carga_datos_covid19_MX(entidad<span class="op">=</span><span class="st">'09'</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>datos/datos_abiertos_covid19.zip</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>FECHA_ACTUALIZACION</th>
      <th>ID_REGISTRO</th>
      <th>ORIGEN</th>
      <th>SECTOR</th>
      <th>ENTIDAD_UM</th>
      <th>SEXO</th>
      <th>ENTIDAD_NAC</th>
      <th>ENTIDAD_RES</th>
      <th>MUNICIPIO_RES</th>
      <th>TIPO_PACIENTE</th>
      <th>...</th>
      <th>CARDIOVASCULAR_BIN</th>
      <th>OBESIDAD_BIN</th>
      <th>RENAL_CRONICA_BIN</th>
      <th>TABAQUISMO_BIN</th>
      <th>OTRO_CASO_BIN</th>
      <th>TOMA_MUESTRA_LAB_BIN</th>
      <th>TOMA_MUESTRA_ANTIGENO_BIN</th>
      <th>MIGRANTE_BIN</th>
      <th>UCI_BIN</th>
      <th>DEFUNCION</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2023-01-03</td>
      <td>180725</td>
      <td>2</td>
      <td>9</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>2</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>TLALPAN</td>
      <td>HOSPITALIZADO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2023-01-03</td>
      <td>1933c0</td>
      <td>1</td>
      <td>12</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>2</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>IZTAPALAPA</td>
      <td>AMBULATORIO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2023-01-03</td>
      <td>0741e4</td>
      <td>2</td>
      <td>6</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>2</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>MIGUEL HIDALGO</td>
      <td>HOSPITALIZADO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2023-01-03</td>
      <td>1c4d2e</td>
      <td>2</td>
      <td>9</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>1</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>TLALPAN</td>
      <td>AMBULATORIO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2023-01-03</td>
      <td>0a6cd6</td>
      <td>2</td>
      <td>6</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>1</td>
      <td>NAYARIT</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>IZTAPALAPA</td>
      <td>AMBULATORIO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>6393642</th>
      <td>2023-01-03</td>
      <td>m1cd235</td>
      <td>2</td>
      <td>12</td>
      <td>MÉXICO</td>
      <td>1</td>
      <td>MÉXICO</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>GUSTAVO A. MADERO</td>
      <td>HOSPITALIZADO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6394417</th>
      <td>2023-01-03</td>
      <td>m0dbc4c</td>
      <td>2</td>
      <td>12</td>
      <td>MÉXICO</td>
      <td>1</td>
      <td>AGUASCALIENTES</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>AZCAPOTZALCO</td>
      <td>AMBULATORIO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6394626</th>
      <td>2023-01-03</td>
      <td>m13431e</td>
      <td>2</td>
      <td>12</td>
      <td>MÉXICO</td>
      <td>1</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>AZCAPOTZALCO</td>
      <td>AMBULATORIO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6394988</th>
      <td>2023-01-03</td>
      <td>m1493ea</td>
      <td>2</td>
      <td>12</td>
      <td>MÉXICO</td>
      <td>1</td>
      <td>MÉXICO</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>GUSTAVO A. MADERO</td>
      <td>AMBULATORIO</td>
      <td>...</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6395781</th>
      <td>2023-01-03</td>
      <td>m0a22b8</td>
      <td>2</td>
      <td>12</td>
      <td>MÉXICO</td>
      <td>2</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>CIUDAD DE MÉXICO</td>
      <td>TLALPAN</td>
      <td>AMBULATORIO</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>1896084 rows × 63 columns</p>
</div>
</div>
</div>
</section>
<section id="guardando-el-resultado" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="guardando-el-resultado"><span class="header-section-number">3.4</span> Guardando el resultado</h2>
<p>Listo, con nuestras funciones tenemos ya nuestros datos preprocesados, ahora vamos a guardarlos para poder utlizarlos rápidamente en otros notebooks. En general tenemos muchas opciones para guardar los datos, csv, por ejemplo. En esta ocasión vamos a usar un formato nativo de Python el <a href="https://docs.python.org/3/library/pickle.html">pickle</a>, que es una forma de <em>serializar</em> un objeto de Python. Pandas nos provee una función para guardar directamente un dataframe como pickle:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df.to_pickle(<span class="st">"data/datos_covid_ene19.pkl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En la documentación de <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_pickle.html">to_pickle</a> pueden ver las opcioones completas.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">"datos/covid_enero_2023_procesados.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../parte_1/02_ejemplo_transformacion.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Limpieza y transformación de datos de COVID-19 en México</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../parte_1/04_visualizacion_covid_1.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Curvas epidémicas</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>