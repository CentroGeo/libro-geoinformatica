<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Geoinformática - 8&nbsp; Pesos Espaciales</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../parte_1/09_autocorrelacion.html" rel="next">
<link href="../parte_1/07_mapas_COVID.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Pesos Espaciales</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Geoinformática</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Prefacio</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">Introducción</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../parte_1.html" class="sidebar-item-text sidebar-link">Geoinformática: las herramientas básicas</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/01_transformacion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Transformación de datos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/02_ejemplo_transformacion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Limpieza y transformación de datos de COVID-19 en México</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/03_automatizacion_transformacion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Automatización</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/04_visualizacion_covid_1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Curvas epidémicas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/05_intro_geopandas.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Objetos geográficos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/06_manipulacion_espacial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Trabajando con objetos espaciales</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/07_mapas_COVID.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Mapas COVID</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/08_pesos_espaciales.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Pesos Espaciales</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_1/09_autocorrelacion.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Autocorrelación espacial</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../parte_2.html" class="sidebar-item-text sidebar-link">Geoinformática en R</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../parte_2/intro_R.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Introducción a R</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../summary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Summary</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#datos" id="toc-datos" class="nav-link active" data-scroll-target="#datos"><span class="toc-section-number">8.1</span>  Datos</a></li>
  <li><a href="#pesos-espaciales-en-pysal" id="toc-pesos-espaciales-en-pysal" class="nav-link" data-scroll-target="#pesos-espaciales-en-pysal"><span class="toc-section-number">8.2</span>  Pesos Espaciales en <code>PySAL</code></a>
  <ul class="collapse">
  <li><a href="#contigüidad" id="toc-contigüidad" class="nav-link" data-scroll-target="#contigüidad"><span class="toc-section-number">8.2.1</span>  Contigüidad</a></li>
  <li><a href="#distancia" id="toc-distancia" class="nav-link" data-scroll-target="#distancia"><span class="toc-section-number">8.2.2</span>  Distancia</a></li>
  </ul></li>
  <li><a href="#rezago-espacial" id="toc-rezago-espacial" class="nav-link" data-scroll-target="#rezago-espacial"><span class="toc-section-number">8.3</span>  Rezago Espacial</a></li>
  <li><a href="#para-practicar" id="toc-para-practicar" class="nav-link" data-scroll-target="#para-practicar"><span class="toc-section-number">8.4</span>  Para Practicar…</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Pesos Espaciales</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>En esta práctica vamos a revisar una de las piezas más importantes del análisis espacial: las Matrices de Pesos Espaciales. A través de estas matrices se formalizan las relaciones de vecindad entre todas las observaciones de un conjunto de datos; en otras palabras, una Matriz de Pesos Espaciales de una geografía dada es una <em><a href="https://es.wikipedia.org/wiki/Matriz_definida_positiva">matriz definida positiva</a></em> de dimensiones <span class="math inline">\(N\)</span> por <span class="math inline">\(N\)</span>, donde <span class="math inline">\(N\)</span> es el número total de observaciones en los datos:</p>
<p><span class="math display">\[
W = \left(\begin{array}{cccc}
0 &amp; w_{12} &amp; \dots &amp; w_{1N} \\
w_{21} &amp; \ddots &amp; w_{ij} &amp; \vdots \\
\vdots &amp; w_{ji} &amp; 0 &amp; \vdots \\
w_{N1} &amp; \dots &amp; \dots &amp; 0
\end{array} \right)
\]</span></p>
<p>donde cada celda <span class="math inline">\(w_{ij}\)</span> contiene un valor que representa el grado de contacto o interacción espacial entre las observaciones <span class="math inline">\(i\)</span> y <span class="math inline">\(j\)</span>.</p>
<p>Dos conceptos fundamentales dentro de este ámbito son el de <em>vecino</em> y <em>vecindad</em>. Por convención, todos los elementos de la diagonal principal (<span class="math inline">\(w_{ij}\)</span>) se les asigna cero; el <em>vecino</em> de cualquier observación <span class="math inline">\(i\)</span> es otra observación con la cual <span class="math inline">\(i\)</span> tiene cierta conectividad. En términos de la matriz <span class="math inline">\(W\)</span>, las observaciones <span class="math inline">\(i\)</span> y <span class="math inline">\(j\)</span> serán <em>vecinos</em> si se cumple que <span class="math inline">\(w_{ij} &gt; 0\)</span>. Siguiendo esta lógica, la <em>vecindad</em> de <span class="math inline">\(i\)</span> será el conjunto de observaciones en el sistema con las cuales posee cierta conexión, o, en otras palabras, todas las observaciones con las que comparte un valor de peso mayor que cero.</p>
<p>Hay múltiples formas en las que pueden crearse estas matrices, y muchas otras en las que pueden ser transformadas para que la información representada se alinie lo más posible con la forma en la que entendemos las interacciones espaciales entre los elementos de un sistema. En esta sesión, trabajaremos con la librería <a href="https://pysal.org/">PySAL</a> que es el estándar para análisis espacial en Python.</p>
<p>Como siempre, comenzamos por importar las librerías que vamos a usar.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> libpysal.weights <span class="im">import</span> W,Queen, Rook, KNN, DistanceBand, min_threshold_distance, block_weights, lag_spatial</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<section id="datos" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="datos"><span class="header-section-number">8.1</span> Datos</h2>
<p>Vamos a seguir utilizando las AGEB’s de la Ciudad de México, esta vez con dos columnas importantes: <code>alcaldia</code>, que contiene la Clave Geográfica de la Alcaldía dentro de la cual se encuentra dicho AGEB, y <code>p_sderech</code>, que indica el número de personas sin derechohabienca a servicios de salud, de acuerdo con información colectada por el Consejo Nacional de Evaluación de Política del Desarrollo Social (CONEVAL) en 2010.</p>
<p>Como siempre, los datos necesarios se encuentran en la carpeta de datos del libro, por practicidad, aquí está la <a href="https://www.dropbox.com/s/chm152w8yha4w6t/pob_sinderechohab.zip?dl=1">liga</a> para descargar los datos.</p>
<p>Una vez descargados los datos, usamos GeoPandas para leerlos:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>agebs <span class="op">=</span> gpd.read_file(<span class="st">'datos/pob_sinderechohab.zip'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>agebs.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cvegeo</th>
      <th>alcaldia</th>
      <th>p_sderech</th>
      <th>p_nescu</th>
      <th>p_hacin</th>
      <th>p_analf</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0900700013628</td>
      <td>09007</td>
      <td>389.0</td>
      <td>475.0</td>
      <td>0.0</td>
      <td>9.0</td>
      <td>POLYGON ((2810132.372 824698.172, 2810169.540 ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0901500010235</td>
      <td>09015</td>
      <td>323.0</td>
      <td>481.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>POLYGON ((2798881.634 831643.241, 2798843.076 ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0900200010097</td>
      <td>09002</td>
      <td>448.0</td>
      <td>780.0</td>
      <td>5.0</td>
      <td>37.0</td>
      <td>POLYGON ((2792415.239 836846.390, 2792356.808 ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0900200011184</td>
      <td>09002</td>
      <td>240.0</td>
      <td>389.0</td>
      <td>0.0</td>
      <td>11.0</td>
      <td>POLYGON ((2792260.139 836768.777, 2792333.695 ...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0900300011285</td>
      <td>09003</td>
      <td>1017.0</td>
      <td>1291.0</td>
      <td>0.0</td>
      <td>23.0</td>
      <td>POLYGON ((2802121.600 817466.682, 2802124.157 ...</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<hr>
</section>
<section id="pesos-espaciales-en-pysal" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="pesos-espaciales-en-pysal"><span class="header-section-number">8.2</span> Pesos Espaciales en <code>PySAL</code></h2>
<section id="contigüidad" class="level3" data-number="8.2.1">
<h3 data-number="8.2.1" class="anchored" data-anchor-id="contigüidad"><span class="header-section-number">8.2.1</span> Contigüidad</h3>
<p>Las Matrices de Contigüidad definen las relaciones de vecindad a través de la existencia de fronteras comúnes. Esto facilita enormemente el utilizar este tipo de matrices con polígonos: si dos polígonos comparten frontera de alguna forma, serán entoces etiquetadas como vecinos; el nivel en el cual tienen que compartir esta frontera será dado por el criterio que se elija para ello, teniéndose los criterios de Reina o de Torre.</p>
<section id="criterio-de-reina" class="level4" data-number="8.2.1.1">
<h4 data-number="8.2.1.1" class="anchored" data-anchor-id="criterio-de-reina"><span class="header-section-number">8.2.1.1</span> Criterio de Reina</h4>
<p>Bajo éste, basta con que dos polígonos compartan únicamente un sólo vértice de sus fronteras para ser considerados vecinos, en PySAL podemos crear una matriz de contigüidad con el criterio de reina haciendo:</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>m_reina <span class="op">=</span> Queen.from_dataframe(agebs, idVariable<span class="op">=</span><span class="st">'cvegeo'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>m_reina</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/plablo/.miniconda3/envs/geoinformatica/lib/python3.10/site-packages/libpysal/weights/weights.py:172: UserWarning: The weights matrix is not fully connected: 
 There are 8 disconnected components.
 There is 1 island with id: 090090015012A.
  warnings.warn(message)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>&lt;libpysal.weights.contiguity.Queen at 0x7f9f027e5ed0&gt;</code></pre>
</div>
</div>
<p>Estamos guardando en la variable <code>m_reina</code> un objeto del tipo <a href="https://pysal.org/libpysal/generated/libpysal.weights.Queen.html"><code>libpysal.weights.contiguity.Queen</code></a> que representa la matriz de vecindad que calculamos. Noten el <em>warning</em> que nos sale: “There is 1 island with id: 1356”, eso quiere decir que la observación con índice 1356 no está conectada a ninguna otra bajo el criterio que usamos.</p>
<p>Las Matrices Espaciales en <code>PySAL</code> ofrecen la facilidad de encontrar rápidamente las relaciones de contigüidad que posee. Por ejemplo, si se quisiera saber cuáles son los vecinos de la AGEB en la que se encuentra el CentroGeo (0901200010337), se tendría que:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>m_reina[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>{'0901200012066': 1.0,
 '0901200010642': 1.0,
 '0901200011369': 1.0,
 '0901200010341': 1.0,
 '0901200010322': 1.0,
 '0901200010638': 1.0}</code></pre>
</div>
</div>
<p>El comando anterior arroja un diccionario que contiene las Claves Geográficas de cada vecino como identificadores, y los pesos a los que se asocia como sus respectivos valores; debido a que se trata de una Matriz Espacial de contigüidad, todos los vecinos tienen asignados un peso de uno. Si se quisiera tener el peso de un vecino en particular, se puede realizar una búsqueda recursiva:</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>m_reina[<span class="st">'0901200010337'</span>][<span class="st">'0901200010341'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>1.0</code></pre>
</div>
</div>
<p>También pueden obtenerse de forma aislada una lista de los vecinos de cada observación, así como de sus respectivos pesos, gracias a los atributos <code>neighbors</code> y <code>weights</code> del objeto creado:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>m_reina.neighbors[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>['0901200012066',
 '0901200010642',
 '0901200011369',
 '0901200010341',
 '0901200010322',
 '0901200010638']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>m_reina.weights[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>[1.0, 1.0, 1.0, 1.0, 1.0, 1.0]</code></pre>
</div>
</div>
<p>A través del objeto contenido en la variable <code>m_reina</code> es posible obtener información de la matriz que va mucho más allá de los atributos básicos que uno esperaría. Por ejemplo, es posible acceder de forma directa al número de vecinos que posee una observacioń a través del atributo <code>cardinalities</code>:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>m_reina.cardinalities[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>6</code></pre>
</div>
</div>
<p>Y, debido a que el resultado de <code>cardinalities</code> es un diccionario, éste puede ser transformado directamente en un objeto del tipo <code>Series</code>:</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>card_reina <span class="op">=</span> pd.Series(m_reina.cardinalities)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>card_reina.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>0900200010010    3
0900200010025    4
090020001003A    4
0900200010044    4
0900200010097    4
dtype: int64</code></pre>
</div>
</div>
<p>Esto, a su vez, permite realizar cosas como graficas que, en este caso, nos permite tener una visión general del tamaño de las vecindades en general:</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>sns.displot(card_reina, rug <span class="op">=</span> <span class="va">True</span>, kde <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>&lt;seaborn.axisgrid.FacetGrid at 0x7f9e91ae4d90&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08_pesos_espaciales_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>La gráfica anterior permite deducir que la mayoría de las observaciones poseen alrededor de cinco y sesis vecinos, existiendo algo de variación entre los datos; así mismo, aunque son las menos, también existen observaciones con un gran número de vecinos, llegándose hasta los 20 vecinos.</p>
<p>A continuación se presenta algo de la información adicional que puede obtenerse de la Matriz de Pesos Espaciales, a través de sus atributos particulares:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Número de Observaciones</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>m_reina.n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>2397</code></pre>
</div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Número Promedio de Vecinos</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>m_reina.mean_neighbors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>5.677096370463079</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Número Mínimo de Vecinos</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>m_reina.min_neighbors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>0</code></pre>
</div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Número Máximo de Vecinos</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>m_reina.max_neighbors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>20</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Islas (Observaciones Desconectadas del Resto / Sin Vecinos)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>m_reina.islands</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>['090090015012A']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Orden en que se encuentran las Observaciones (en este caso, las primeras cinco)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>m_reina.id_order[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>['0900200010010',
 '0900200010025',
 '090020001003A',
 '0900200010044',
 '0900200010097']</code></pre>
</div>
</div>
<p>También podemos hacer visualizaciones para observar algunas características de las matrices de contigüidad. Por ejemplo, podemos ver los vecinos de una unidad en particular. En el siguiente código podemos ver las agebs vecinas de la ageb en la que se encuentra el CentroGeo</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparar la figura </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>fig , filas <span class="op">=</span> plt.subplots(<span class="dv">1</span>, figsize <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar la Capa Base</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>agebs.plot(ax <span class="op">=</span> filas , facecolor <span class="op">=</span> <span class="st">'grey'</span>, linewidth <span class="op">=</span> <span class="fl">0.1</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Seleccionar el Polígono Focal (Tanto la Clave Geográfica como la Geometría tienen sus propios corchetes)</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>centrogeo <span class="op">=</span> agebs.set_index(<span class="st">'cvegeo'</span>).loc[[<span class="st">'0901200010337'</span>] , [<span class="st">'geometry'</span>]]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar el Polígono Focal</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>centrogeo.plot(ax <span class="op">=</span> filas , facecolor <span class="op">=</span> <span class="st">'red'</span>, alpha <span class="op">=</span> <span class="dv">1</span>, linewidth <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar los Vecinos</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>vecinos <span class="op">=</span> agebs.set_index(<span class="st">'cvegeo'</span>).loc[m_reina[<span class="st">'0901200010337'</span>], :]</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>vecinos.plot(ax <span class="op">=</span> filas , facecolor <span class="op">=</span> <span class="st">'lime'</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Título</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">'Vecinos del AGEB 0901200010337 (CentroGeo)'</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Acercamiento a los Polígonos</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>filas.set_ylim(<span class="fl">811882.7509</span> , <span class="fl">815282.7509</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>filas.set_xlim(<span class="fl">2789417.0236</span> , <span class="fl">2792817.0236</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_7969/3035649815.py:14: FutureWarning: Passing a dict as an indexer is deprecated and will raise in a future version. Use a list instead.
  vecinos = agebs.set_index('cvegeo').loc[m_reina['0901200010337'], :]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(2789417.0236, 2792817.0236)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="08_pesos_espaciales_files/figure-html/cell-18-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>Es importante remarcar el proceso a través del cual fue construída la gráfica; primero, se agregó el mapa base, después el polígono de interés, para seguir con la vecindad y, finalmente, realizar el acercamiento deseado.</p>
</section>
<section id="criterio-de-torre" class="level4" data-number="8.2.1.2">
<h4 data-number="8.2.1.2" class="anchored" data-anchor-id="criterio-de-torre"><span class="header-section-number">8.2.1.2</span> Criterio de Torre</h4>
<p>La Contigüidad de Torre es similar, en este caso dos observaciones se consideran contiguas si comparten una arista (es decir, una línea). Desde el punto de vista técnico, una Matriz de Pesos Espaciales con Contigüidad de Torre se construye de forma muy similar al de Reina:</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>m_torre <span class="op">=</span> Rook.from_dataframe(agebs, idVariable <span class="op">=</span> <span class="st">'cvegeo'</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>m_torre</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/plablo/.miniconda3/envs/geoinformatica/lib/python3.10/site-packages/libpysal/weights/weights.py:172: UserWarning: The weights matrix is not fully connected: 
 There are 11 disconnected components.
 There is 1 island with id: 090090015012A.
  warnings.warn(message)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>&lt;libpysal.weights.contiguity.Rook at 0x7f9e90b50100&gt;</code></pre>
</div>
</div>
<p>El objeto contenido en la variable <code>m_torre</code> pude ser utilizado y explorado exactamente de la misma manera que <code>m_reina</code>.</p>
</section>
<section id="ejercicio-haz-un-mapa-de-la-vecindad-de-reina-para-el-ageb-de-centrogeo" class="level4" data-number="8.2.1.3">
<h4 data-number="8.2.1.3" class="anchored" data-anchor-id="ejercicio-haz-un-mapa-de-la-vecindad-de-reina-para-el-ageb-de-centrogeo"><span class="header-section-number">8.2.1.3</span> Ejercicio, haz un mapa de la vecindad de reina para el ageb de CentroGeo</h4>
<hr>
</section>
</section>
<section id="distancia" class="level3" data-number="8.2.2">
<h3 data-number="8.2.2" class="anchored" data-anchor-id="distancia"><span class="header-section-number">8.2.2</span> Distancia</h3>
<p>Las matrices basadas en distancia asignan el peso de cada par de observaciones como una función de qué tan lejos se encuentran entre sí; cómo se traduce esta regla en un valor fijo varía en función de múltiples criterios, pero todos giran alrededor del hecho de que la distancia entre las observaciones determinará el Peso Espacial.</p>
<section id="k-vecinos-más-cercanos-knn" class="level4" data-number="8.2.2.1">
<h4 data-number="8.2.2.1" class="anchored" data-anchor-id="k-vecinos-más-cercanos-knn"><span class="header-section-number">8.2.2.1</span> K-Vecinos Más Cercanos (KNN)</h4>
<p>Una forma de definir los Pesos Espaciales es tomar las distancias entre una observación determinada y el resto de los datos, ordenarlos en función de su distancia y considerar como vecinos a los <span class="math inline">\(k\)</span> más cercanos; esto es exactamente lo que hace el criterio de <span class="math inline">\(k\)</span>-Vecinos Más Cercanos (KNN, por sus siglas en inglés).</p>
<p>Para calcular una Matriz de Pesos Espaciales a través del criterio KNN, se utiliza una función muy similar a la usada con los Criterios de Contigüidad:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>knn5 <span class="op">=</span> KNN.from_dataframe(agebs, ids<span class="op">=</span><span class="st">'cvegeo'</span>, k <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>knn5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>&lt;libpysal.weights.distance.KNN at 0x7f9e90b7e920&gt;</code></pre>
</div>
</div>
<p>Puede observarse que es necesario indicar el número de vecinos que se deberán de considerar, a través del argumento <code>k</code>. Asímismo, ésta función cuenta con una forma diferente de asignar los ID’s a cada observación, haciéndolo a través del argumento <code>ids</code>; en lugar de indicar el nombre de la variable que funcionará como identificador.</p>
<p>La función automáticamente calcula los centroides de cada observación para calcular la distancia entre las mismas.</p>
</section>
<section id="ejercicio" class="level4" data-number="8.2.2.2">
<h4 data-number="8.2.2.2" class="anchored" data-anchor-id="ejercicio"><span class="header-section-number">8.2.2.2</span> Ejercicio</h4>
<p>Visualiza los vecinos más cercanos a la ageb de CentroGeo para valores de k de 4,5,6 y 7 y pon todos los mapas en la misma figura</p>
</section>
<section id="banda-de-distancia" class="level4" data-number="8.2.2.3">
<h4 data-number="8.2.2.3" class="anchored" data-anchor-id="banda-de-distancia"><span class="header-section-number">8.2.2.3</span> Banda de Distancia</h4>
<p>Otra forma de obtener una Matriz de Pesos Espaciales basada en Distancias es trazar un círculo de radio determinado y considerar como vecino a toda observación que se encuentre dentro de éste. Esta técnica posee dos variaciones: Binaria y Contínua; en la primera, todos los vecinos son asignados un peso de uno, mientras que en la segunda las observaciones son ajustadas en función a la distancia a la observación de interés.</p>
<p>Para generar matrices con Bandas de Distancias Binarias en <code>PySAL</code>, se utiliza el siguiente comando:</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>m_dist1kmB <span class="op">=</span> DistanceBand.from_dataframe(agebs , threshold<span class="op">=</span><span class="dv">1000</span> , binary<span class="op">=</span><span class="va">True</span> , ids<span class="op">=</span><span class="st">'cvegeo'</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>m_dist1kmB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/plablo/.miniconda3/envs/geoinformatica/lib/python3.10/site-packages/libpysal/weights/weights.py:172: UserWarning: The weights matrix is not fully connected: 
 There are 34 disconnected components.
 There are 14 islands with ids: 0901200011759, 0900200010877, 0900300010770, 0900400010369, 0900400010373, 0900400200316, 090090015012A, 0900900330488, 0900900360242, 0901200011195, 0901200012155, 0901200262297, 0901300011474, 0901300011578.
  warnings.warn(message)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>&lt;libpysal.weights.distance.DistanceBand at 0x7f9e90b50340&gt;</code></pre>
</div>
</div>
<p>Noten que el parámetro <code>threshold</code>, que definoe el <em>ancho</em> de la banda de distancia, está en las unidades de la proyección de la capa.</p>
<p>Esto crea una matriz binaria que considera como vecinos de una observación a todo polígono cuyo centroide se encuentre dentro de un radio de 1,000 metros (1km) del centroide de la observación, límite expresado a través del argumento <code>threshold</code>; además, se especifica que la matriz sea binaria a través del argumento <code>binary</code>. Como tal, si se observan los vecinos del AGEB de CentroGeo:</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>m_dist1kmB[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>{'0901200010657': 1.0,
 '0901200010638': 1.0,
 '0901200010318': 1.0,
 '0901200010322': 1.0,
 '0901200010341': 1.0,
 '0901200010642': 1.0,
 '0901200011369': 1.0,
 '0901200011388': 1.0}</code></pre>
</div>
</div>
<p>Es importante destacar que las unidades en las que se especifica la distancia del círculo dependen del Sistema de Coordenadas de Referencia (CRS) en el que se encuentren proyectados los datos, por lo que es importante tomarlo en cuenta al momento de ingresar el valor. El CRS de un <code>GeoDataFrame</code> puede ser revisado a través de su atributo <code>crs</code>:</p>
<p>En este caso, se tiene el sistema con el EPSG 6362, equivalente a la Proyección Cónica Conforme de Lambert (LCC) para México, la cual utiliza como unidades al metro, teniendo entonces sentido el haber colocado dentro del argumento <code>treshold</code> el valor de 1,000 para representar 1km.</p>
<p>Una extensión de lo anterior implica el añadir mayor detalle al asignar diferentes pesos a los diferentes vecinos dentro del círculo de radio determinado en función de su distancia a la observación de interés; una forma de hacer esto es utilizando el inverso de la distancia entre dos observaciones como su peso. Esto se realiza a través de la variante Contínua del método, la cual se consigue modificando el argumento <code>binary</code> del comando utilizado anteriormente:</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>m_dist1kmC <span class="op">=</span> DistanceBand.from_dataframe(agebs , threshold<span class="op">=</span><span class="dv">1000</span> , binary<span class="op">=</span><span class="va">False</span>, ids<span class="op">=</span><span class="st">'cvegeo'</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>m_dist1kmC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/plablo/.miniconda3/envs/geoinformatica/lib/python3.10/site-packages/scipy/sparse/_data.py:117: RuntimeWarning: divide by zero encountered in reciprocal
  return self._with_data(data ** n)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>&lt;libpysal.weights.distance.DistanceBand at 0x7f9e9133e380&gt;</code></pre>
</div>
</div>
<p>Con <code>m_dist1kmC</code>, a toda observación dentro del círculo de 1km se le asigna un peso igual al inverso de la distancia entre cada par de observaciones:</p>
<p><span class="math display">\[
w_{ij} = \dfrac{1}{d_{ij}}
\]</span></p>
<p>De esta forma, mientras más alejadas se encuentren <span class="math inline">\(i\)</span> y <span class="math inline">\(j\)</span> entre sí, menor será el peso <span class="math inline">\(w_{ij}\)</span>. Esto puede verificarse observando nuevamente los valores para los vecinos del AGEB de CentroGeo:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>m_dist1kmC[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>{'0901200010657': 0.0011186366205468501,
 '0901200010638': 0.001430708698453151,
 '0901200010318': 0.0015967606198248982,
 '0901200010322': 0.002801456949838892,
 '0901200010341': 0.0016416791117487674,
 '0901200010642': 0.0014321050161851287,
 '0901200011369': 0.0011074818342581747,
 '0901200011388': 0.0010068495493531873}</code></pre>
</div>
</div>
<hr>
<p>Siguiendo esta lógica de ajustar los pesos a través de las distancias, existe la posibilidad de hacer que todos los elementos de un conjunto de datos se conviertan en vecinos entre sí, ya que siempre existirá alguna distancia entre todos los pares posibles; sin embargo, aunque conceptualmente correcto, esta decisión no siempre es la más práctica o computacionalmente correcta pues, debido a la naturaleza de las Matrices de Pesos Espaciales, particularmente el hecho de que tienen dimensiones de <span class="math inline">\(N\)</span> por <span class="math inline">\(N\)</span>, éstas pueden crecer substancialmente en tamaño.</p>
<p>Una forma de resolver el problema anterior es asegurándose de que la matriz posea múltiples ceros en su interior. En el caso de las matrices de contigüidad, así como las del criterio KNN, la presencia de estos ceros se encuentra asegurada; sin embargo, en el caso del Inverso de la Distancia, necesita imponerse la presencia de éstos pues, de lo contrario, puede convertise en una matriz muy densa (Esto es, con pocos o ningún cero más que los de la diagonal principal).</p>
<p>En términos prácticos, lo que usualmente se hace es imponer una distancia límite de la cual más allá no se asignará ningún peso, y se asume que no hay interacción alguna. Además de hacer el proceso más sencillo computacionalmente, los resultados obtenidos con esta distancia no difieren mucho de los que se tendría con una matriz completamente densa, debido a que la información eliminada con la distancia normalmente corresponde a pesos espaciales muy pequeños.</p>
<p>En este contexto, un umbral comúnmente utilizado, aunque no siempre el mejor, es aquel en el que se asegura que todas las observaciones tengan por lo menos un vecino. Esta distancia puede calcularse fácilmente usando la función <a href="https://pysal.org/libpysal/generated/libpysal.weights.min_threshold_distance.html#libpysal.weights.min_threshold_distance">min_threshold_distance</a>. La entrada de esta función no es el GeoDataFrame sino la lista de coordenadas de los centroides, afortunadamente es muy fácil pasar del GeoDataFrame a la lista de coordenadas</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>coordenadas <span class="op">=</span> np.array([(pt.x , pt.y) <span class="cf">for</span> pt <span class="kw">in</span> agebs.centroid])</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>coordenadas</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>array([[2810184.3953237 ,  824630.90277965],
       [2798795.09167579,  831549.7671602 ],
       [2792280.44399879,  837098.86138355],
       ...,
       [2807793.98111279,  828749.42701419],
       [2807892.48374243,  828610.97973225],
       [2807674.47595458,  828330.05069586]])</code></pre>
</div>
</div>
<p>Y ahora sí podemos calcular nuestro umbral de distancia</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dist_min <span class="op">=</span> min_threshold_distance(coordenadas)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>dist_min</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>1958.9642337770003</code></pre>
</div>
</div>
<p>Teniendo esto, puede volverse a calcular la Matriz de Pesos con Banda de Distancia Contínua utilizando ésta nueva distancia calculada como umbral:</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>m_distmin <span class="op">=</span> DistanceBand.from_dataframe(agebs, threshold <span class="op">=</span> dist_min , binary <span class="op">=</span> <span class="va">False</span>, ids <span class="op">=</span> <span class="st">'cvegeo'</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>m_distmin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/plablo/.miniconda3/envs/geoinformatica/lib/python3.10/site-packages/scipy/sparse/_data.py:117: RuntimeWarning: divide by zero encountered in reciprocal
  return self._with_data(data ** n)
/home/plablo/.miniconda3/envs/geoinformatica/lib/python3.10/site-packages/libpysal/weights/weights.py:172: UserWarning: The weights matrix is not fully connected: 
 There are 2 disconnected components.
  warnings.warn(message)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>&lt;libpysal.weights.distance.DistanceBand at 0x7f9e913e6aa0&gt;</code></pre>
</div>
</div>
<p>Si se revisan los vecinos de la AGEB del CentroGeo en esta matriz, se notará que se señalan como tal todas las AGEB’s contenidas dentro de la Alcaldía Tlalpan, donde se encuentra el Centro:</p>
</section>
<section id="ejercicio-opcional" class="level4" data-number="8.2.2.4">
<h4 data-number="8.2.2.4" class="anchored" data-anchor-id="ejercicio-opcional"><span class="header-section-number">8.2.2.4</span> Ejercicio Opcional</h4>
<p>Utilizando la Matriz de Pesos por Bloques, intenta crear un mapa similar al generado anteriormente con la Matriz de Contigüidad de Reina. ___ ## Estandarización de Matrices</p>
<p>En el contexto de muchas técnicas de análisis espacial, una Matriz de contigüidad, que nos indica sólo si dos unidades son o no vecinos,no es siempre la más adecuada para un análisis, por lo que algún tipo de transformación es requerida, lo cual implica modificar cada peso para que se conforme a ciertas reglas. <code>PySAL</code> posee múltiples transformaciones preparadas para las matrices que genera, así que resulta sencillo modificarla y examinarla.</p>
<p>Tomando en cuenta la Matriz de Contigüidad de Reina generada anteriormente, para la AGEB del CentroGeo:</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>m_reina[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>{'0901200012066': 1.0,
 '0901200010642': 1.0,
 '0901200011369': 1.0,
 '0901200010341': 1.0,
 '0901200010322': 1.0,
 '0901200010638': 1.0}</code></pre>
</div>
</div>
<p>Debido a que se trata de un criterio de contigüidad, todos los vecinos del AGEB poseen un peso de 1, mientras que el resto poseen un cero. Es posible verificar si el objeto <code>m_reina</code> ha sido transformado o no al llamar al atributo <code>transform</code>:</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>m_reina.transform</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>'O'</code></pre>
</div>
</div>
<p>Donde <code>'O'</code> significa ‘Original’, esto es, ninguna transformación ha sido aplicada. Si se buscara aplicar una transformación sobre las filas de la matriz, de modo que todas las filas de ésta sumen en total 1, el atributo <code>transform</code> es modificado de la siguiente forma:</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>m_reina.transform <span class="op">=</span> <span class="st">'R'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('WARNING: ', '090090015012A', ' is an island (no neighbors)')</code></pre>
</div>
</div>
<p>De modo que, si se revisa nuevamente la vecindad del AGEB de CentroGeo, se encontrarán los pesos modificados:</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>m_reina[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>{'0901200012066': 0.16666666666666666,
 '0901200010642': 0.16666666666666666,
 '0901200011369': 0.16666666666666666,
 '0901200010341': 0.16666666666666666,
 '0901200010322': 0.16666666666666666,
 '0901200010638': 0.16666666666666666}</code></pre>
</div>
</div>
<p>Sin considerar algunas limitaciones de precisión del lenguaje, puede constatarse que la suma de los pesos de todos los vecinos es igual a uno:</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>pd.Series(m_reina[<span class="st">'0901200010337'</span>]).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>0.9999999999999999</code></pre>
</div>
</div>
<p>La matriz puede ser regresada fácilmente a su estado original, simplemente modificando el atributo <code>transform</code> de la forma correcta:</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>m_reina.transform <span class="op">=</span> <span class="st">'O'</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>m_reina[<span class="st">'0901200010337'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>{'0901200012066': 1.0,
 '0901200010642': 1.0,
 '0901200011369': 1.0,
 '0901200010341': 1.0,
 '0901200010322': 1.0,
 '0901200010638': 1.0}</code></pre>
</div>
</div>
<p><code>PySAL</code> permite realizar sobre las matrices las siguientes transformaciones: * <code>'O'</code> - Original, permite regresar a la matriz a su estado inicial. * <code>'B'</code> - Binario, asignándole a todos los vecinos un peso de uno. * <code>'R'</code> - Fila (Row), haciendo que el peso de todos los vecinos de una observación dada sumen uno. * <code>'V'</code> - Estabilizados de Varianza, restringiéndose la suma de todos los pesos de la matriz al número de observaciones. ___ ## Exportar e Importar Pesos Espaciales con PySAL Existen casos en los que un Conjunto de Datos es muy detallado o de gran tamaño, lo cual puede complicar la construcción de las Matrices de Pesos Espaciales y, aún con las optimizaciones del código de <code>PySAL</code>, el tiempo de cómputo puede crecer enormemente; en estas situaciones, es útil el no tener que reconstruir la matriz desde cero cada vez que se necesite volver a correr un análisis. Una sólución para este problema es el construir la matriz una única ocasión, para después exportarla y tenerla almacenada en un sitio donde pueda ser consultada cuando se necesite.</p>
<p>La forma en la que <code>PySAL</code> realiza la exportación de cualqueir tipo de matriz es a través del comando <code>open</code>, siendo necesario únicamente determinar el formato en que se exportará ésta. Aunque existen múltiples formatos en los cuales las matrices pueden ser almacenadas, existen dos comúnmente utilizadas:</p>
</section>
<section id="formato-.gal---matrices-de-contigüidad" class="level4" data-number="8.2.2.5">
<h4 data-number="8.2.2.5" class="anchored" data-anchor-id="formato-.gal---matrices-de-contigüidad"><span class="header-section-number">8.2.2.5</span> Formato <code>.gal</code> - Matrices de Contigüidad</h4>
<p>Las Matrices de Contigüidad pueden ser almacenadas en un archivo tipo <code>.gal</code>a través de los siguientes comandos:</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>m_reina.to_file(<span class="st">"datos/m_reina.gal"</span>, <span class="st">'gal'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Este objeto lo podemos leer fácilmente</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>m_reina2 <span class="op">=</span> W.from_file(<span class="st">"datos/m_reina.gal"</span>, <span class="st">'gal'</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>m_reina2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/plablo/.miniconda3/envs/geoinformatica/lib/python3.10/site-packages/libpysal/weights/weights.py:172: UserWarning: The weights matrix is not fully connected: 
 There are 8 disconnected components.
 There is 1 island with id: 090090015012A.
  warnings.warn(message)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>&lt;libpysal.weights.weights.W at 0x7f9e9138a1d0&gt;</code></pre>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="rezago-espacial" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="rezago-espacial"><span class="header-section-number">8.3</span> Rezago Espacial</h2>
<p>Una de las aplicaciones más directas de las Matrices de Pesos Espaciales es el cálculo del <em>Rezago Espacial</em>; éste se define como el producto de una Matriz de Pesos Espaciales con una variable en particular:</p>
<p><span class="math display">\[
Y_{sl} = W Y
\]</span></p>
<p>Donde <span class="math inline">\(Y\)</span> es un vector de dimensiones <span class="math inline">\(Nx1\)</span> con los valores de la variable. Cabe recordar que el producto entre una matriz y un vector es igual a la suma de todas las multiplicaciones entre la columna de la variable y las filas de la matriz, para los valores resultantes de una columna dada; lo anterior, dicho en términos de Rezago Espacial, se representa como:</p>
<p><span class="math display">\[
y_{sl-i} = \displaystyle \sum_j w_{ij} y_j
\]</span></p>
<p>Si se utilizan pesos estandarizados por fila en la Matriz de Pesos Espaciales, entonces <span class="math inline">\(w_{ij}\)</span> se convierte en una proporción entre cero y uno, y <span class="math inline">\(y_{sl-i}\)</span> puede ser visto como el valor promedio de <span class="math inline">\(Y\)</span> para la vecindad de <span class="math inline">\(i\)</span>.</p>
<p>El Rezago Espacial es un elemento fundamental para muchas técnicas de análisis espacial y, como tal, <code>PySAL</code> provee la función<a href="https://pysal.org/libpysal/generated/libpysal.weights.lag_spatial.html">lag_spatial</a> para calcularlo de forma sencilla. En los datos originales existe una variable llamada <code>p_sderech</code>, referente al número de personas sin derechoahabienca a servicios públicos de salud dentro de la Ciudad de México, de acuerdo con información colectada por el Consejo Nacional de Evaluación de Política del Desarrollo Social (CONEVAL) en 2010; si se quisiera calcular el rezago espacial para esa variable, entonces se tendría:</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estandarización de la Matriz de Contigüidad de Reina por Filas</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>m_reina.transform <span class="op">=</span> <span class="st">'R'</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cálculo del rezago espacial para el Número de Personas sin Derechohabiencia a Servicios Públicos de Salud</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>rez_espacial <span class="op">=</span> lag_spatial(m_reina , agebs[<span class="st">'p_sderech'</span>])</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar los primeros cinco elementos del vector generado</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>rez_espacial[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>array([337. , 419.5, 484.5, 409. , 500. ])</code></pre>
</div>
</div>
<p>De los comandos anteriores, la línea 5 contiene el comando donde se genera el cálculo deseado, el cual se encuentra altamente optimizado en <code>PySAL</code>. Aunque dentro de la función se utilizó un objeto del tipo <code>Series</code>, a través de <code>agebs['p_sderech']</code>, el resultado es una lista y, como tal, puede ser añadida directamente al <code>GeoDataFrame</code> con el que se ha trabajado hasta ahora:</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>agebs[<span class="st">'rez_espacial'</span>] <span class="op">=</span> rez_espacial</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>agebs.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>cvegeo</th>
      <th>alcaldia</th>
      <th>p_sderech</th>
      <th>p_nescu</th>
      <th>p_hacin</th>
      <th>p_analf</th>
      <th>geometry</th>
      <th>rez_espacial</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0900700013628</td>
      <td>09007</td>
      <td>389.0</td>
      <td>475.0</td>
      <td>0.0</td>
      <td>9.0</td>
      <td>POLYGON ((2810132.372 824698.172, 2810169.540 ...</td>
      <td>337.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0901500010235</td>
      <td>09015</td>
      <td>323.0</td>
      <td>481.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>POLYGON ((2798881.634 831643.241, 2798843.076 ...</td>
      <td>419.5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0900200010097</td>
      <td>09002</td>
      <td>448.0</td>
      <td>780.0</td>
      <td>5.0</td>
      <td>37.0</td>
      <td>POLYGON ((2792415.239 836846.390, 2792356.808 ...</td>
      <td>484.5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0900200011184</td>
      <td>09002</td>
      <td>240.0</td>
      <td>389.0</td>
      <td>0.0</td>
      <td>11.0</td>
      <td>POLYGON ((2792260.139 836768.777, 2792333.695 ...</td>
      <td>409.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0900300011285</td>
      <td>09003</td>
      <td>1017.0</td>
      <td>1291.0</td>
      <td>0.0</td>
      <td>23.0</td>
      <td>POLYGON ((2802121.600 817466.682, 2802124.157 ...</td>
      <td>500.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<section id="ejercicio-opcional-1" class="level4" data-number="8.3.0.1">
<h4 data-number="8.3.0.1" class="anchored" data-anchor-id="ejercicio-opcional-1"><span class="header-section-number">8.3.0.1</span> Ejercicio Opcional</h4>
<p>Analiza el Rezago Espacial calculado y almacenado en la variable <code>rez_espacial</code> generando una Gráfica de Densidad de Kernel o un Histograma de forma similar a como se hizo en prácticas anteriores; compara esta gráfica con una similar para la variable <code>p_sderech</code> y responde: ¿Qué diferencias se pueden observar? ___ ## Gráfica de Moran La Gráfica de Moran es una forma de visualización que permite empezar a explorar el concepto de <em>Autocorrelación Espacial</em>, y demuestra una aplicación directa de las Matrices de Pesos Espaciales y el Rezago Espacial. En escencia, se trata de un simple Diagrama de Dispersión en el que una determinada variable (<code>p_sderech</code>, por ejemplo) es graficada junto con su propio rezago espacial; usualmente se adiciona una regresión lineal para poder inferir una mayor cantidad de información:</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparación de la Figura y sus Filas</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>fig , filas <span class="op">=</span> plt.subplots(<span class="dv">1</span> , figsize <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables de la Gráfica</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>sns.regplot(x <span class="op">=</span> <span class="st">'p_sderech'</span>, y <span class="op">=</span> <span class="st">'rez_espacial'</span>, data <span class="op">=</span> agebs)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostar Gráfica</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="08_pesos_espaciales_files/figure-html/cell-38-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Para tener la capacidad de comparar entre múltiples diagramas de dispersión y poder encontrar observaciones atípicas, es común estandarizar los valores de una variable antes de calcular su rezago espacial y graficarlo. Esto se consigue de forma sencilla al restar el promedio de la variable y dividir el resultado entre su desviación estándar:</p>
<p><span class="math display">\[
z_i = \dfrac{y - \bar{y}}{\sigma_y}
\]</span></p>
<p>Donde <span class="math inline">\(z_i\)</span> es la versión estandarizada de <span class="math inline">\(y_i\)</span>, <span class="math inline">\(\bar{y}\)</span> es el promedio de la variable y <span class="math inline">\(\sigma\)</span> su desviación estándar.</p>
<p>Crear una Gráfica de Moran Estandarizada implica que los valores promedio se encuentren en el centro de la gráfica (debido a que se convierten en cero al estandarizar), y su dispersión se encuentra expresada en desviaciones estándar, teniéndose a todos los valores que sean más grandes o más pequeños que dos desviaciones estándar como valores atípicos. Una Gráfica de Moran Estandarizada también permite dividir al espacio en cuatro cuadrantes que representan situaciones diferentes:</p>
<ul>
<li>Cuadrante I - Altos-Altos (HH), valores mayores a la media rodeados por valores mayores a la media.</li>
<li>Cuadrante II - Bajos-Altos (LH), valores menores a la media rodeados de valores mayores a la media.</li>
<li>Cuadrante III - Bajos-Bajos (LL), valores menores a la media rodeados de valores menores a la media.</li>
<li>Cuadrante IV - Altos-Bajos (HL), valores mayores a la media rodeados por valores menores a la media.</li>
</ul>
<p>Éstos se estudiarán más a detalle en futuras prácticas.</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estandarizar el Número de Robos por AGEB</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>robos_std <span class="op">=</span> (agebs[<span class="st">'p_sderech'</span>] <span class="op">-</span> agebs[<span class="st">'p_sderech'</span>].mean()) <span class="op">/</span> agebs[<span class="st">'p_sderech'</span>].std()</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcular el Rezago Espacial de la variable estandarizada y asignarle los índices originales</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>rez_espacial_std <span class="op">=</span> pd.Series(lag_spatial(m_reina , robos_std) , index <span class="op">=</span> robos_std.index)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparación de la Figura y sus Filas</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>fig , filas <span class="op">=</span> plt.subplots(<span class="dv">1</span> , figsize <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Graficar los Valores</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>sns.regplot(x <span class="op">=</span> robos_std , y <span class="op">=</span> rez_espacial_std)</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Añadir líneas horizontal y vertical</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="dv">0</span>, c <span class="op">=</span> <span class="st">'grey'</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>)</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, c <span class="op">=</span> <span class="st">'grey'</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>)</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Mostrar la Gráfica</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="08_pesos_espaciales_files/figure-html/cell-39-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
</section>
</section>
<section id="para-practicar" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="para-practicar"><span class="header-section-number">8.4</span> Para Practicar…</h2>
<p>Crea una Gráfica de Moran Estandarizada para cada una de las siguientes variables, también presentes en el <code>ShapeFile</code> original: * <code>p_nescu</code> - Población de 15 a 24 años que no asiste a la escuela * <code>p_hacin</code> - Población que vive en Hacinamiento * <code>p_analf</code> - Población de 15 años o más analfabeta</p>
<p>Intenta generar todas las gráficas utilizando un bucle (<em>Loop</em>) de tipo <code>for</code>; también intenta explorar y utilizar la función <code>.joinplot()</code> de la librería <code>seaborn</code> para generar un resultado más completo (Información de la función <a href="http://seaborn.pydata.org/tutorial/regression.html#plotting-a-regression-in-other-contexts">aquí</a> y <a href="http://seaborn.pydata.org/generated/seaborn.jointplot.html#seaborn.jointplot">aquí</a>)</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../parte_1/07_mapas_COVID.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Mapas COVID</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../parte_1/09_autocorrelacion.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Autocorrelación espacial</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>